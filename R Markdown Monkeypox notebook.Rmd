---
title: "Monkey Pox Genetics May 2022"
output: html_notebook
---
# Introduction
[YouTube tutorial](https://www.youtube.com/watch?v=qhLSfx_wpeA) uploaded by [Dr. Danny Arends](https://dannyarends.nl/?).

Notebook completed by Samantha Martell

Opened: 29 May 2022

Final edit: 

## To-do list
1. Where do we get our data from? (e.g. USA, Portugal, Belgium). Source from NCBI. 
2. Load genome sequences from fasta and NCBI.
3. Create a blast database.
4. Load associated proteins from NCBI.
5. Create a protein model (Levenstein, MSA) -> consensus.
6. tblastn Consensus to viral genomes database.
7. Genomic layout of the virus.

### What is a consensus sequence?
A consensus sequence is a sequence of DNA, RNA, or protein that represents aligned, related sequences. The consensus sequence of the related sequences can be defined in different ways, but is normally defined by the most common nucleotide(s) or amino acid residue(s) at each position ([source](https://en.wikipedia.org/wiki/Consensus_sequence)).

# Initialising the notebook {.tabset}
## Clear environment
```{r}
rm(list = ls())
```

## Set working directory
```{r}
# set working directory
setwd("C:/Users/samma/Monkeypox-genetics/")
cat(getwd())
list.files()
```
## Install packages
* Install packages as required. 
  * [Multiple Sequence Alignment](https://bioconductor.org/packages/release/bioc/html/msa.html)
```{r}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("msa")
```


## Importing packages
```{r}
library(msa)
library(RColorBrewer)
library(rentrez)
library(stringdist)
library(seqinr)
```

# 0 Getting data from NCBI
* Go to [NCBI nucleotide database](https://www.ncbi.nlm.nih.gov/nuccore)
* Search for monkeypox
* GenBank ID is ON563414.2
  * Relatively long at 197124 bp
* Should compare an (older) annotated genome with one of these newer genomes. 
* Danny has kindly put a .txt file containing information on various monkeypoxes and related viruses.
  * Based on set from [virological.org](https://virological.org/).
  
```{r}
sourceIDs <- read.csv(
  file = "data/monkeypox_annotation.txt", 
  sep = "\t", 
  header = TRUE, 
  row.names = 1
)

# check the dataframe
head(sourceIDs)
```
Check the structure of the new dataframe. 
```{r}
str(sourceIDs)
```

  
# 1 Load genome sequences
Use the function defined in `R/downloadData.R` to download data from the NCBI nucleotide database according to the sourceIDs given in Part 0.

```{r}
source("R/downloadData.R")
ncbi.seq <- downloadData(rownames(sourceIDs))
```

```{r}
class(ncbi.seq)
length(ncbi.seq)
str(ncbi.seq)
```

# 2 Creating a blast database
Use the function defined in `R/makeBlastDB.R` to write data downloaded in Part 1 to a file to avoid continuously accessing data from NCBI. 

```{r}
source("R/makeBlastDB.R")
makeBlastDB(ncbi.seq, "data/DNAdb.fsa")
```

## Writing to a file - Sam Edition
Alternatively, write to .csv file since I can't get the. fsa file to read back in nicely. 
```{r}
write.csv(ncbi.seq, "data/DNAdb.csv")
```

Test the new file.
```{r}
source("R/readBlastDBasCsv.R")
db.test <- readBlastDBasCsv("data/DNAdb.csv")
```

```{r}
str(db.test)
```

# 3 Load associated proteins from NCBI
This code finds the proteins in the protein database which are annotated to the [NC_003310.1](https://www.ncbi.nlm.nih.gov/nuccore/NC_003310.1/) sequence. 
```{r}
links <- entrez_link(dbfrom = "nuccore", id = "NC_003310.1", db = "protein")
```

```{r}
links
str(links)
```
`cd` describes a coding sequence. Doesn't matter which of the `List of 2` we take.

```{r}
proteins.ids <- links$links$nuccore_protein

proteins.ids
length(proteins.ids)
class(proteins.ids)
```

This list only has 191 entries because the sequence is annotated. If this were to be repeated with an unannotated sequence, the list size would be 0.

```{r}
query.proteins <- function(id = "NC_003310.1"){
  links <- entrez_link(dbfrom = "nuccore", id = id, db = "protein")
  protein.ids <- links$links$nuccore_protein
  
  if(length(protein.ids) > 0){
    protein.seq <- download.data(protein.ids, "protein")
    return(protein.seq)
  }
  return(NULL)
}
```

```{r}
my.proteins <- query.proteins()
```

```{r}
str(my.proteins)
length(my.proteins)
```

We will query a few of these proteins - download a fraction of 191.  
```{r}
proteins <- c()
for (name in names(ncbi.seq)){
  proteins <- c(proteins, query.proteins(name))
  Sys.sleep(5)
}
```

```{r}
str(proteins)
```









